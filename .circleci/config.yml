version: 2
jobs:
  build:
    working_directory: /root/source
    docker:
      - image: mono:latest
    steps:
      - run:
          name: Update APT listing
          command: apt-get -qq update
      - run:
          name: Install git, distributed version control system
          command: apt-get -qq -y install git
      - checkout
      - restore_cache:
          keys:
            - v1-packages-{{ checksum "ESBreakerCLI/packages.config" }}
            # Find the most recent cache used from any branch
            - v1-packages-
      - run:
          name: Restore .NET packages
          command: nuget restore -NonInteractive -Verbosity quiet
      - save_cache:
          key: v1-packages-{{ checksum "ESBreakerCL/packages.config" }}
          paths:
            - packages
      - restore_cache:
          keys:
            # Find the most recent cache used from any branch
            - v1-APK-
      - run:
          command: ESBreakCLI/prebuild.sh ESBReakCLI/
      - save_cache:
          key: v1-APK-{{ epoch }}
          paths:
            - ESBreakerCI/lib/*.apk
      - run:
          name: Build Release
          command: msbuild /p:BuildWithMono="true" /p:Configuration=Release
      - run:
          name: Debug Release
          command: msbuild /p:BuildWithMono="true" /p:Configuration=Debug
      - run:
          name: Delete External DLLs
          command: find ESBreakerCLI/bin -name "ContentsSerializer.dll" -or -name "Assembly-CSharp-firstpass.dll" -or -name "UnityEngine.dll" -or -name "protobuf-net.dll" -or -name "ProtoBuffSerializer.dll" -delete
      - store_artifacts:
          path: /root/build/Release
          destination: Release
      - store_artifacts:
          path: /root/build/Debug
          destination: Debug

